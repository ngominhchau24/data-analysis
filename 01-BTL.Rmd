# Giới thiệu và Kiểm tra Chất lượng Dữ liệu

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

Bộ dữ liệu **Coffee NIR** chứa thông tin về các mẫu cà phê được đo lường thông qua phổ cận hồng ngoại (Near-Infrared Spectroscopy - NIRS) cùng với các thông số hóa lý được phân tích bằng phương pháp hóa học truyền thống.

## Đọc dữ liệu

```{r load-libraries}
# Load các thư viện cần thiết
library(tidyverse)
library(naniar)
library(visdat)
library(DataExplorer)
library(knitr)
library(kableExtra)
library(ggplot2)
library(gridExtra)
```

```{r load-data}
# Đọc dữ liệu
coffee_data <- read.csv("coffee_nirs.csv", sep = ";", row.names = 1, stringsAsFactors = FALSE)

# Chuyển đổi các cột số (xử lý dấu chấm làm dấu phân cách hàng nghìn)
# Hàm chuyển đổi từ format Châu Âu (dấu chấm = phân cách nghìn, dấu phẩy = thập phân)
convert_to_numeric <- function(x) {
  if(is.character(x)) {
    # Loại bỏ dấu chấm (phân cách hàng nghìn) và thay dấu phẩy thành dấu chấm (thập phân)
    x <- gsub("\\.", "", x)  # Loại bỏ dấu chấm
    x <- gsub(",", ".", x)   # Thay dấu phẩy thành dấu chấm
    return(as.numeric(x))
  }
  return(x)
}

# Áp dụng cho tất cả các cột trừ Localisation
for(col in names(coffee_data)) {
  if(col != "Localisation") {
    coffee_data[[col]] <- convert_to_numeric(coffee_data[[col]])
  }
}

# Xem cấu trúc dữ liệu
dim(coffee_data)

# Kiểm tra kiểu dữ liệu đã chuyển đổi thành công
cat("Kiểm tra kiểu dữ liệu:\n")
cat("- CGA:", class(coffee_data$CGA), "\n")
cat("- Localisation:", class(coffee_data$Localisation), "\n")
cat("- S1:", class(coffee_data$S1), "\n")
```

Bộ dữ liệu có **`r nrow(coffee_data)`** mẫu và **`r ncol(coffee_data)`** biến.

## Các Nhóm Biến trong Dữ liệu

Dữ liệu Coffee NIR được chia thành 3 nhóm biến chính:

### Biến Hóa lý (Chemical-Physical Variables)

Đây là các thông số hóa học được đo bằng phương pháp phân tích hóa học truyền thống trong phòng thí nghiệm:

```{r chemical-vars}
chemical_vars <- c("CGA", "Cafeine", "Fat", "Trigonelline", "DM")

# Hiển thị thống kê mô tả
coffee_data %>%
  select(all_of(chemical_vars)) %>%
  summary() %>%
  kable(caption = "Thống kê mô tả các biến hóa lý") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

**Mô tả các biến:**

- **CGA** (Chlorogenic Acid): Axit chlorogenic - một hợp chất polyphenol quan trọng trong cà phê, ảnh hưởng đến hương vị và tính chống oxi hóa
- **Cafeine**: Hàm lượng cafein - alkaloid kích thích thần kinh
- **Fat**: Hàm lượng chất béo - ảnh hưởng đến độ béo ngậy và hương vị
- **Trigonelline**: Một alkaloid ảnh hưởng đến hương thơm và vị đắng
- **DM** (Dry Matter): Hàm lượng chất khô - chỉ số chất lượng tổng thể

**Ý nghĩa:** Các biến hóa lý này là chỉ số chất lượng quan trọng của cà phê, thường được sử dụng làm biến phụ thuộc (y) trong mô hình dự đoán.

### Biến Vị trí địa lý (Location)

```{r location-var}
# Kiểm tra biến Localisation
location_summary <- coffee_data %>%
  count(Localisation, name = "Số lượng mẫu") %>%
  arrange(desc(`Số lượng mẫu`))

location_summary %>%
  kable(caption = "Phân bố mẫu theo vị trí địa lý") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r location-plot, fig.height=4}
# Biểu đồ phân bố
ggplot(location_summary, aes(x = factor(Localisation), y = `Số lượng mẫu`)) +
  geom_bar(stat = "identity", fill = "#2E86AB") +
  geom_text(aes(label = `Số lượng mẫu`), vjust = -0.5) +
  labs(
    title = "Phân bố mẫu cà phê theo vị trí địa lý",
    x = "Vị trí (Location ID)",
    y = "Số lượng mẫu"
  ) +
  theme_minimal()
```

**Ý nghĩa:** Biến `Localisation` cho biết vị trí địa lý hoặc nguồn gốc của mẫu cà phê. Đây có thể là biến phân loại quan trọng vì điều kiện đất đai, khí hậu ảnh hưởng đến chất lượng cà phê.

### Biến NIR (Near-Infrared Spectroscopy)

```{r nir-vars}
# Các biến NIR (S1 đến S1050)
nir_vars <- grep("^S[0-9]+$", names(coffee_data), value = TRUE)

cat("Số lượng biến NIR:", length(nir_vars), "\n")
cat("Phạm vi bước sóng:", min(nir_vars), "đến", max(nir_vars), "\n")
```

**Mô tả:**

- Dữ liệu phổ NIR gồm **`r length(nir_vars)` điểm đo** (từ S1 đến S1050)
- Mỗi điểm đại diện cho cường độ hấp thụ ánh sáng tại một bước sóng cụ thể
- Phổ NIR chứa thông tin về thành phần hóa học của mẫu dựa trên dao động phân tử

```{r nir-spectra-plot}
# Vẽ một số phổ NIR mẫu
set.seed(123)
sample_indices <- sample(1:nrow(coffee_data), 10)

# Chuyển dữ liệu sang dạng long format để vẽ
nir_data_long <- coffee_data[sample_indices, nir_vars] %>%
  mutate(sample = row_number()) %>%
  pivot_longer(cols = -sample, names_to = "wavelength", values_to = "absorbance") %>%
  mutate(wavelength = as.numeric(str_remove(wavelength, "S")))

ggplot(nir_data_long, aes(x = wavelength, y = absorbance, color = factor(sample))) +
  geom_line(alpha = 0.7) +
  labs(
    title = "Phổ NIR của 10 mẫu ngẫu nhiên",
    x = "Số thứ tự điểm đo (S1-S1050)",
    y = "Cường độ hấp thụ",
    color = "Mẫu"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

**Ý nghĩa:** Dữ liệu NIR là biến độc lập (X) chính, được sử dụng để dự đoán các thông số hóa lý một cách nhanh chóng và không phá hủy mẫu.

## Kiểm tra Dữ liệu Thiếu (Missing Data)

```{r missing-overview}
# Tổng quan về missing data
miss_summary <- miss_var_summary(coffee_data)

cat("Tổng số biến có dữ liệu thiếu:", sum(miss_summary$n_miss > 0), "\n")
cat("Tổng số quan sát thiếu:", sum(is.na(coffee_data)), "\n")
cat("Tỷ lệ dữ liệu thiếu tổng thể:", round(mean(is.na(coffee_data)) * 100, 2), "%\n")
```

### Phân tích chi tiết Missing Data

```{r missing-by-group}
# Missing trong các biến hóa lý
miss_chemical <- coffee_data %>%
  select(all_of(chemical_vars)) %>%
  miss_var_summary()

cat("\n**Dữ liệu thiếu trong các biến Hóa lý:**\n")
miss_chemical %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Missing trong biến Location
miss_location <- coffee_data %>%
  select(Localisation) %>%
  miss_var_summary()

cat("\n**Dữ liệu thiếu trong biến Vị trí:**\n")
miss_location %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

# Missing trong các biến NIR
miss_nir <- coffee_data %>%
  select(all_of(nir_vars)) %>%
  miss_var_summary() %>%
  filter(n_miss > 0)

if(nrow(miss_nir) > 0) {
  cat("\n**Dữ liệu thiếu trong các biến NIR:**\n")
  head(miss_nir, 20) %>%
    kable() %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
} else {
  cat("\n**Không có dữ liệu thiếu trong các biến NIR**\n")
}
```

### Trực quan hóa Missing Data

```{r missing-viz, fig.height=8}
# Visualize missing data pattern
vis_miss(coffee_data, warn_large_data = FALSE) +
  labs(title = "Mẫu dữ liệu thiếu trong toàn bộ dataset")
```

```{r missing-chemical-viz}
# Missing pattern cho biến hóa lý
if(sum(is.na(coffee_data[, chemical_vars])) > 0) {
  gg_miss_var(coffee_data[, chemical_vars]) +
    labs(title = "Số lượng missing values theo biến hóa lý")
}
```

### Nhận xét về Missing Data

```{r missing-conclusion}
# Tính toán và hiển thị kết luận
total_cells <- nrow(coffee_data) * ncol(coffee_data)
missing_cells <- sum(is.na(coffee_data))
missing_pct <- (missing_cells / total_cells) * 100

cat("**Kết luận:**\n\n")
cat("- Tổng số ô dữ liệu:", format(total_cells, big.mark = ","), "\n")
cat("- Số ô thiếu dữ liệu:", format(missing_cells, big.mark = ","), "\n")
cat("- Tỷ lệ thiếu:", round(missing_pct, 3), "%\n\n")

if(missing_pct < 1) {
  cat("Bộ dữ liệu có chất lượng tốt với tỷ lệ thiếu dữ liệu rất thấp.\n")
} else if(missing_pct < 5) {
  cat("Bộ dữ liệu có chất lượng khá tốt, cần xem xét xử lý missing data.\n")
} else {
  cat("Bộ dữ liệu có nhiều giá trị thiếu, cần xử lý cẩn thận.\n")
}
```

## Kiểm tra Giá trị Lạ (Outliers)

### Outliers trong Biến Hóa lý

```{r outliers-chemical}
# Chuẩn hóa dữ liệu hóa lý để so sánh
data_chemical <- coffee_data[, chemical_vars]

# Chuyển sang long format để vẽ boxplot
data_chemical_long <- data_chemical %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value")

# Boxplot cho các biến hóa lý
ggplot(data_chemical_long, aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 16, outlier.size = 2) +
  facet_wrap(~variable, scales = "free") +
  labs(
    title = "Phát hiện Outliers trong các biến Hóa lý",
    x = "Biến",
    y = "Giá trị"
  ) +
  theme_minimal() +
  theme(legend.position = "none", axis.text.x = element_blank())
```

#### Phân tích chi tiết Outliers

```{r outliers-analysis}
# Hàm tính outliers theo IQR method
detect_outliers <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR

  outliers <- x < lower_bound | x > upper_bound

  return(list(
    n_outliers = sum(outliers, na.rm = TRUE),
    pct_outliers = round(mean(outliers, na.rm = TRUE) * 100, 2),
    lower_bound = lower_bound,
    upper_bound = upper_bound
  ))
}

# Phân tích outliers cho từng biến hóa lý
outlier_summary <- data.frame(
  Variable = character(),
  N_Outliers = numeric(),
  Pct_Outliers = numeric(),
  Lower_Bound = numeric(),
  Upper_Bound = numeric(),
  stringsAsFactors = FALSE
)

for(var in chemical_vars) {
  result <- detect_outliers(coffee_data[[var]])
  outlier_summary <- rbind(outlier_summary, data.frame(
    Variable = var,
    N_Outliers = result$n_outliers,
    Pct_Outliers = result$pct_outliers,
    Lower_Bound = round(result$lower_bound, 4),
    Upper_Bound = round(result$upper_bound, 4)
  ))
}

outlier_summary %>%
  kable(caption = "Thống kê Outliers trong biến Hóa lý (IQR Method)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

### Outliers trong Biến NIR

```{r outliers-nir}
# Lấy mẫu một số biến NIR để phân tích
set.seed(123)
sample_nir_vars <- sample(nir_vars, 50)

# Tính outliers cho các biến NIR mẫu
nir_outlier_counts <- sapply(coffee_data[, sample_nir_vars], function(x) {
  detect_outliers(x)$n_outliers
})

cat("Số lượng outliers trung bình trong 50 biến NIR ngẫu nhiên:",
    round(mean(nir_outlier_counts), 2), "\n")
```

```{r outliers-nir-plot}
# Boxplot cho một số biến NIR
data_nir_sample <- coffee_data[, sample_nir_vars[1:9]] %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value")

ggplot(data_nir_sample, aes(x = variable, y = value, fill = variable)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 16, outlier.size = 1) +
  facet_wrap(~variable, scales = "free", ncol = 3) +
  labs(
    title = "Phát hiện Outliers trong 9 biến NIR mẫu",
    x = "Biến",
    y = "Giá trị"
  ) +
  theme_minimal() +
  theme(legend.position = "none", axis.text.x = element_blank())
```

### Phân tích Multivariate Outliers

```{r multivariate-outliers}
# Sử dụng Mahalanobis distance cho biến hóa lý
data_chem_complete <- coffee_data[complete.cases(coffee_data[, chemical_vars]), chemical_vars]

if(nrow(data_chem_complete) > 0) {
  # Tính Mahalanobis distance
  mahal_dist <- mahalanobis(
    data_chem_complete,
    colMeans(data_chem_complete),
    cov(data_chem_complete)
  )

  # Ngưỡng chi-square (df = 5 biến hóa lý, alpha = 0.001)
  threshold <- qchisq(0.999, df = 5)

  multivariate_outliers <- mahal_dist > threshold
  n_multi_outliers <- sum(multivariate_outliers)

  cat("Số lượng multivariate outliers (Mahalanobis distance):", n_multi_outliers, "\n")
  cat("Tỷ lệ:", round(n_multi_outliers / nrow(data_chem_complete) * 100, 2), "%\n")

  # Biểu đồ Mahalanobis distance
  data.frame(
    index = 1:length(mahal_dist),
    distance = mahal_dist,
    is_outlier = multivariate_outliers
  ) %>%
    ggplot(aes(x = index, y = distance, color = is_outlier)) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = threshold, linetype = "dashed", color = "red") +
    scale_color_manual(values = c("FALSE" = "blue", "TRUE" = "red")) +
    labs(
      title = "Multivariate Outliers Detection (Mahalanobis Distance)",
      x = "Index mẫu",
      y = "Mahalanobis Distance",
      color = "Outlier"
    ) +
    theme_minimal()
}
```

## Tại sao cần phát hiện và xử lý Outliers?

### Lý do cần kiểm tra Outliers

**1. Ảnh hưởng đến mô hình thống kê:**

   - Outliers có thể làm sai lệch các ước lượng thống kê (trung bình, độ lệch chuẩn)
   - Ảnh hưởng đến hiệu suất của các mô hình hồi quy (PLS, PCR)
   - Giảm độ chính xác dự đoán

**2. Phát hiện lỗi đo lường:**

   - Outliers có thể là kết quả của lỗi kỹ thuật trong quá trình đo NIR
   - Lỗi trong quá trình chuẩn bị mẫu hoặc phân tích hóa học
   - Nhiễm bẩn hoặc contamination mẫu

**3. Phát hiện mẫu đặc biệt:**

   - Một số outliers có thể là mẫu thực sự khác biệt (ví dụ: giống cà phê đặc biệt)
   - Cần phân biệt giữa outliers "xấu" (lỗi) và "tốt" (mẫu đặc biệt)

### Các loại Outliers

```{r outlier-types}
cat("**Trong dữ liệu này, ta quan tâm đến:**\n\n")
cat("1. **Univariate outliers**: Giá trị bất thường trong từng biến riêng lẻ\n")
cat("   - Phát hiện bằng IQR method, Z-score\n")
cat("   - Ví dụ: Hàm lượng Cafeine quá cao hoặc quá thấp\n\n")

cat("2. **Multivariate outliers**: Tổ hợp giá trị bất thường giữa nhiều biến\n")
cat("   - Phát hiện bằng Mahalanobis distance, PCA\n")
cat("   - Ví dụ: Mẫu có tổ hợp CGA-Cafeine bất thường\n\n")

cat("3. **Spectral outliers**: Phổ NIR bất thường\n")
cat("   - Phát hiện bằng PCA score plots, Hotelling T2\n")
cat("   - Quan trọng để đảm bảo chất lượng phổ\n")
```

### Chiến lược xử lý Outliers

```{r outlier-strategy}
strategy_df <- data.frame(
  Bước = c("1", "2", "3", "4"),
  Hành_động = c(
    "Kiểm tra và xác minh outliers",
    "Phân loại outliers",
    "Quyết định xử lý",
    "Đánh giá ảnh hưởng"
  ),
  Mô_tả = c(
    "Xem xét kỹ các mẫu outliers, kiểm tra dữ liệu gốc",
    "Xác định outliers do lỗi kỹ thuật hay mẫu đặc biệt",
    "Loại bỏ, biến đổi hoặc giữ lại tùy thuộc vào nguyên nhân",
    "So sánh mô hình trước và sau khi xử lý outliers"
  )
)

strategy_df %>%
  kable(caption = "Chiến lược xử lý Outliers") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Kết luận

```{r conclusion}
cat("### Tóm tắt chất lượng dữ liệu:\n\n")
cat("**Cấu trúc dữ liệu:**\n")
cat("- Số mẫu:", nrow(coffee_data), "\n")
cat("- Số biến tổng:", ncol(coffee_data), "\n")
cat("  + Biến hóa lý:", length(chemical_vars), "\n")
cat("  + Biến vị trí: 1\n")
cat("  + Biến NIR:", length(nir_vars), "\n\n")

cat("**Chất lượng dữ liệu:**\n")
cat("- Tỷ lệ dữ liệu thiếu:", round(missing_pct, 3), "%\n")
cat("- Số vị trí địa lý:", nrow(location_summary), "\n\n")

cat("**Outliers:**\n")
cat("- Các biến hóa lý có chứa outliers (xem bảng phân tích ở trên)\n")
cat("- Cần xem xét kỹ trước khi quyết định xử lý\n\n")

cat("**Khuyến nghị:**\n")
cat("1. Bộ dữ liệu có chất lượng tốt, ít missing data\n")
cat("2. Cần xử lý outliers một cách cẩn thận trước khi xây dựng mô hình\n")
cat("3. Dữ liệu NIR cần được tiền xử lý (smoothing, normalization) ở bước tiếp theo\n")
cat("4. Xem xét phân tích theo nhóm Localisation nếu thấy sự khác biệt đáng kể\n")
```

---

**Ghi chú:** Đây là bước đầu tiên trong quy trình phân tích dữ liệu. Các bước tiếp theo sẽ bao gồm:

- Tiền xử lý dữ liệu NIR (preprocessing)
- Phân tích thành phần chính (PCA)
- Xây dựng mô hình hồi quy (PLS, PCR)
- Đánh giá và tối ưu hóa mô hình
