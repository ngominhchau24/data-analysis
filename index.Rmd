---
title: "Coffee NIR Data Analysis Report"
author: |
  | **Group 19**
  |
  | *Nguyen Van A - ID: 2012345*  
  | *Tran Thi B - ID: 2012346 * 
  | *Le Van C - ID: 2012347  *
  | *Pham Thi D - ID: 2012348  *
  |
  |
  |
date: "`r Sys.Date()`"
output:
  bookdown::pdf_book:
    latex_engine: xelatex
    keep_tex: true
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
documentclass: book
classoption: [a4paper, openany]
geometry:
  - paper=a4paper
  - top=2.5cm
  - bottom=2.5cm
  - left=3cm
  - right=2cm
  - headheight=17pt
fontsize: 12pt
linestretch: 1.5
header-includes:
  - \usepackage{setspace}
  - \usepackage{indentfirst}
  - \setlength{\parindent}{1.5em}
  - \setlength{\parskip}{6pt}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \fancyhead[R]{\thepage}
  - \fancyhead[L]{\nouppercase{\leftmark}}
  - \renewcommand{\headrulewidth}{0.4pt}
  - \usepackage{caption}
  - \captionsetup[figure]{labelfont=bf, textfont=it}
  - \captionsetup[table]{labelfont=bf, textfont=it}
  - \usepackage{listings}
  - \lstset{breaklines=true, breakatwhitespace=true}
  - \usepackage{fvextra}
  - \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,breakanywhere,commandchars=\\\{\}}
  - \usepackage{titling}
  - \pretitle{\begin{center}\huge\bfseries}
  - \posttitle{\end{center}}
  - \preauthor{\begin{flushleft}\large}
  - \postauthor{\end{flushleft}}
  - \predate{\begin{center}\large}
  - \postdate{\end{center}}
---

```{r global-setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  dev = "cairo_pdf",  # Use Cairo device for UTF-8 support in plots
  fig.align = "center",
  out.width = "85%",
  size = "small"
)

# Load required libraries
library(tidyverse)
library(knitr)
library(kableExtra)

# Read data once for all chapters
coffee_data <- read.csv("coffee_nirs.csv", sep = ";", row.names = 1, stringsAsFactors = FALSE)

# Convert European number format
convert_to_numeric <- function(x) {
  if(is.character(x)) {
    x <- gsub("\\.", "", x)      # Remove dots (thousands separator)
    x <- gsub(",", ".", x)       # Replace comma with dot (decimal)
    return(as.numeric(x))
  }
  return(x)
}

# Apply conversion to all columns except Localisation
for(col in names(coffee_data)) {
  if(col != "Localisation") {
    coffee_data[[col]] <- convert_to_numeric(coffee_data[[col]])
  }
}

# Define variable groups
chemical_vars <- c("CGA", "Cafeine", "Fat", "Trigonelline", "DM")
nir_vars <- grep("^S[0-9]+$", names(coffee_data), value = TRUE)

cat("Data loaded successfully!\n")
cat("Samples:", nrow(coffee_data), "\n")
cat("Chemical variables:", length(chemical_vars), "\n")
cat("NIR wavelengths:", length(nir_vars), "\n")
```

# Giới thiệu {-}
Báo cáo này trình bày toàn bộ kết quả phân tích dữ liệu Coffee NIR, bao gồm:

- **Phần 1**: Giới thiệu dữ liệu và kiểm tra chất lượng
  - Mô tả các nhóm biến: Hóa lý, Location, NIR
  - Kiểm tra dữ liệu thiếu (Missing Data)
  - Phát hiện giá trị lạ (Outliers Detection)

- **Phần 2.1**: Phân tích sự khác biệt - PCA và Clustering
  - Principal Component Analysis (PCA) trên dữ liệu NIR và Hóa lý
  - Hierarchical Clustering và K-means
  - So sánh sự khác biệt giữa các vị trí địa lý
  - Xác định đặc điểm phân biệt giữa các nhóm

- **Phần 2.2**: Phát hiện Outliers nâng cao
  - Hotelling T² statistic và Q residuals (SPE)
  - Combined T² vs Q plot
  - Influence analysis
  - Phân loại và quyết định xử lý outliers

- **Phần 2.3**: Phân tích Tương quan và Heatmap
  - Ma trận tương quan giữa các biến hóa lý
  - Tương quan giữa NIR wavelengths và biến hóa lý
  - Correlation profile và wavelengths quan trọng
  - Tương quan trong không gian PCA
  - So sánh pattern tương quan giữa các Location

- **Phần 2.4**: Mô hình Dự đoán (PLS và PCR)
  - Xây dựng mô hình PLS (Partial Least Squares) Regression
  - Xây dựng mô hình PCR (Principal Component Regression)
  - So sánh hiệu suất giữa PLS và PCR
  - Phân tích Variable Importance (VIP)
  - Đánh giá khả năng ứng dụng thực tế

**Kết quả chính:**
- PCR cho hiệu suất tốt hơn PLS với bộ dữ liệu này
- Cả hai mô hình đều có hiệu suất dự đoán hạn chế (R² thấp)
- Cần cải thiện: thu thập thêm dữ liệu, xử lý outliers, thử phương pháp khác

Dữ liệu sử dụng: **coffee_nirs.csv**
